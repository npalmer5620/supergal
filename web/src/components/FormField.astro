---
export interface Props {
  id: string;
  label: string;
  type?: 'text' | 'email' | 'password' | 'textarea' | 'number' | 'date' | 'datetime-local' | 'select';
  placeholder?: string;
  required?: boolean;
  maxLength?: number;
  minLength?: number;
  rows?: number;
  value?: string | number;
  error?: string;
  help?: string;
  options?: { value: string; label: string }[];
  disabled?: boolean;
}

const {
  id,
  label,
  type = 'text',
  placeholder,
  required = false,
  maxLength,
  minLength,
  rows = 4,
  value = '',
  error,
  help,
  options = [],
  disabled = false
} = Astro.props;

const hasError = !!error;
---

<div class="mb-6">
  <label for={id} class="block text-sm font-medium text-gray-700 mb-2">
    {label}
    {required && <span class="text-red-500">*</span>}
  </label>

  {type === 'textarea' ? (
    <div>
      <textarea
        id={id}
        name={id}
        placeholder={placeholder}
        required={required}
        maxlength={maxLength}
        minlength={minLength}
        rows={rows}
        disabled={disabled}
        class={`w-full px-4 py-2 border rounded-lg font-mono text-sm focus:outline-none focus:ring-2 transition-colors ${
          hasError
            ? 'border-red-500 focus:ring-red-500 focus:border-transparent'
            : 'border-gray-200 focus:ring-gray-900 focus:border-transparent'
        } ${disabled ? 'bg-gray-50 text-gray-500 cursor-not-allowed' : 'bg-white'}`}
      >
        {value}
      </textarea>

      {maxLength && (
        <div class={`text-xs mt-2 ${value?.toString().length === maxLength ? 'text-red-500' : 'text-gray-500'}`}>
          <span class="char-count">{value?.toString().length || 0}</span> / {maxLength} characters
        </div>
      )}
    </div>
  ) : type === 'select' ? (
    <select
      id={id}
      name={id}
      required={required}
      disabled={disabled}
      value={value}
      class={`w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 transition-colors ${
        hasError
          ? 'border-red-500 focus:ring-red-500 focus:border-transparent'
          : 'border-gray-200 focus:ring-gray-900 focus:border-transparent'
      } ${disabled ? 'bg-gray-50 text-gray-500 cursor-not-allowed' : 'bg-white'}`}
    >
      <option value="">Select an option</option>
      {options.map(opt => (
        <option value={opt.value}>{opt.label}</option>
      ))}
    </select>
  ) : (
    <input
      id={id}
      name={id}
      type={type}
      placeholder={placeholder}
      required={required}
      maxlength={maxLength}
      minlength={minLength}
      value={value}
      disabled={disabled}
      class={`w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 transition-colors ${
        hasError
          ? 'border-red-500 focus:ring-red-500 focus:border-transparent'
          : 'border-gray-200 focus:ring-gray-900 focus:border-transparent'
      } ${disabled ? 'bg-gray-50 text-gray-500 cursor-not-allowed' : 'bg-white'}`}
    />
  )}

  {maxLength && type !== 'textarea' && (
    <div class={`text-xs mt-2 ${value?.toString().length === maxLength ? 'text-red-500' : 'text-gray-500'}`}>
      <span class="char-count">{value?.toString().length || 0}</span> / {maxLength} characters
    </div>
  )}

  {error && (
    <div class="mt-2 text-sm text-red-600 flex items-start gap-2">
      <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
      </svg>
      <span>{error}</span>
    </div>
  )}

  {help && !error && (
    <div class="mt-2 text-sm text-gray-500">
      {help}
    </div>
  )}
</div>

<script lang="ts">
  // Character count update on input
  document.addEventListener('input', (e) => {
    if ((e.target as HTMLElement).matches('[maxlength]')) {
      const target = e.target as HTMLInputElement | HTMLTextAreaElement;
      const charCount = target.parentElement?.querySelector('.char-count');
      if (charCount) {
        charCount.textContent = String(target.value.length);
      }
    }
  });
</script>
