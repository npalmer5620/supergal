---
import type { Image } from '../utils/api';

export interface Props {
  images: Image[];
}

const { images = [] } = Astro.props;
---

<div class="space-y-4">
  <div class="flex items-center justify-between">
    <label class="block text-sm font-medium text-gray-700">Gallery Images</label>
    <span class="text-xs text-gray-500" id="image-count">{images.length} image(s)</span>
  </div>

  {images.length > 0 ? (
    <div
      id="images-list"
      class="border border-gray-200 rounded-lg divide-y bg-white"
    >
      {images.map((image, index) => (
        <div
          key={image.id}
          class="flex items-center gap-4 p-4 hover:bg-gray-50 group cursor-move drag-item"
          data-image-id={image.id}
          draggable="true"
        >
          <!-- Drag Handle -->
          <div class="flex-shrink-0 cursor-grab active:cursor-grabbing text-gray-400 group-hover:text-gray-600">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>

          <!-- Image Thumbnail -->
          <div class="flex-shrink-0 w-16 h-16 bg-gray-200 rounded overflow-hidden">
            <img
              src={image.urls?.thumbnail200 || image.urls?.original}
              alt={image.title}
              class="w-full h-full object-cover"
            />
          </div>

          <!-- Image Info -->
          <div class="flex-grow min-w-0">
            <p class="font-medium text-gray-900 truncate">{image.title}</p>
            <p class="text-sm text-gray-500 truncate">{image.filename}</p>
          </div>

          <!-- Order Buttons -->
          <div class="flex-shrink-0 flex gap-2">
            <button
              type="button"
              class="order-up-btn p-2 text-gray-400 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              title="Move up"
              disabled={index === 0}
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
              </svg>
            </button>
            <button
              type="button"
              class="order-down-btn p-2 text-gray-400 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              title="Move down"
              disabled={index === images.length - 1}
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
          </div>

          <!-- Remove Button -->
          <button
            type="button"
            class="remove-btn flex-shrink-0 p-2 text-gray-400 hover:text-red-600 transition-colors"
            title="Remove from gallery"
          >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      ))}
    </div>
  ) : (
    <div class="border border-dashed border-gray-300 rounded-lg p-8 text-center text-gray-500">
      <p>No images in this gallery</p>
      <p class="text-sm">Select images above to add them</p>
    </div>
  )}

  <!-- Hidden field for image order -->
  <input
    type="hidden"
    id="image-order"
    name="imageOrder"
    value={images.map(img => img.id).join(',')}
  />
</div>

<script lang="ts">
  const imagesList = document.getElementById('images-list');
  const imageOrderField = document.getElementById('image-order') as HTMLInputElement;
  const imageCountEl = document.getElementById('image-count');

  if (!imagesList) {
    // No images, nothing to do
  } else {
    let draggedElement: Element | null = null;

    // Drag and drop handlers
    imagesList.addEventListener('dragstart', (e) => {
      draggedElement = (e.target as HTMLElement).closest('.drag-item');
      (draggedElement as HTMLElement).style.opacity = '0.5';
    });

    imagesList.addEventListener('dragend', () => {
      if (draggedElement) {
        (draggedElement as HTMLElement).style.opacity = '1';
      }
      draggedElement = null;
    });

    imagesList.addEventListener('dragover', (e) => {
      e.preventDefault();
      const afterElement = getDragAfterElement(e.clientY);
      if (afterElement) {
        imagesList.insertBefore(draggedElement as Element, afterElement);
      } else if (draggedElement) {
        imagesList.appendChild(draggedElement);
      }
      updateImageOrder();
    });

    function getDragAfterElement(y: number): Element | null {
      const draggableElements = [...imagesList.querySelectorAll('.drag-item:not([style*="opacity"])')]
        .filter(el => el !== draggedElement);

      for (let element of draggableElements) {
        const box = element.getBoundingClientRect();
        if (y < box.top + box.height / 2) {
          return element;
        }
      }
      return null;
    }

    // Up/Down button handlers
    imagesList.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('button');
      if (!btn) return;

      const item = btn.closest('.drag-item') as HTMLElement;
      if (!item) return;

      if (btn.classList.contains('order-up-btn')) {
        const previous = item.previousElementSibling;
        if (previous) {
          imagesList.insertBefore(item, previous);
          updateImageOrder();
        }
      } else if (btn.classList.contains('order-down-btn')) {
        const next = item.nextElementSibling;
        if (next && next.nextElementSibling) {
          imagesList.insertBefore(item, next.nextElementSibling);
        } else if (next) {
          imagesList.appendChild(item);
        }
        updateImageOrder();
      } else if (btn.classList.contains('remove-btn')) {
        if (confirm('Remove this image from the gallery?')) {
          item.remove();
          updateImageOrder();
        }
      }
    });

    function updateImageOrder() {
      const imageIds = Array.from(imagesList.querySelectorAll('.drag-item')).map(item =>
        (item as HTMLElement).getAttribute('data-image-id')
      );

      imageOrderField.value = imageIds.join(',');

      // Update button states
      const items = imagesList.querySelectorAll('.drag-item');
      items.forEach((item, index) => {
        const upBtn = (item as HTMLElement).querySelector('.order-up-btn') as HTMLButtonElement;
        const downBtn = (item as HTMLElement).querySelector('.order-down-btn') as HTMLButtonElement;

        if (upBtn) upBtn.disabled = index === 0;
        if (downBtn) downBtn.disabled = index === items.length - 1;
      });

      // Update image count
      if (imageCountEl) {
        imageCountEl.textContent = `${items.length} image(s)`;
      }
    }

    // Initial button state setup
    updateImageOrder();
  }
</script>

<style>
  .drag-item {
    transition: opacity 0.2s;
  }

  .drag-item.dragging {
    opacity: 0.5;
  }
</style>
