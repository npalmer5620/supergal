---
import FormField from './FormField.astro';
import PublishControls from './PublishControls.astro';
import ImageSelector from './ImageSelector.astro';
import ImageReorderer from './ImageReorderer.astro';
import FormAlert from './FormAlert.astro';

export interface Props {
  gallery?: {
    id?: number;
    title: string;
    slug: string;
    description?: string;
    status?: 'draft' | 'published';
    scheduledDate?: string;
    createdAt?: string;
    updatedAt?: string;
    images?: any[];
  };
  onSubmit?: string;
  submitText?: string;
  isLoading?: boolean;
}

const {
  gallery = {
    title: '',
    slug: '',
    description: '',
    status: 'draft',
    scheduledDate: '',
    images: []
  },
  onSubmit = '/admin/galleries',
  submitText = 'Create Gallery',
  isLoading = false
} = Astro.props;
---

<form id="gallery-form" method="POST" action={onSubmit} class="space-y-6">
  <!-- Success/Error Messages -->
  <div id="form-alerts" class="space-y-4"></div>

  <!-- Main Content Area -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Details (2/3 width) -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Title Field -->
      <FormField
        id="title"
        label="Gallery Title"
        type="text"
        placeholder="My beautiful collection"
        required={true}
        maxLength={150}
        value={gallery.title}
        help="Create a descriptive title for your gallery"
      />

      <!-- Slug Field -->
      <div>
        <label for="slug" class="block text-sm font-medium text-gray-700 mb-2">
          URL Slug <span class="text-gray-500 font-normal">(auto-generated from title)</span>
        </label>
        <div class="flex gap-2">
          <input
            type="text"
            id="slug"
            name="slug"
            value={gallery.slug}
            class="flex-grow px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent"
            required
          />
          <button
            type="button"
            id="regenerate-slug-btn"
            class="px-4 py-2 bg-gray-200 text-gray-900 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium"
          >
            Regenerate
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Slug is used in the URL for your gallery</p>
      </div>

      <!-- Description Field -->
      <FormField
        id="description"
        label="Description"
        type="textarea"
        placeholder="Tell us about this gallery..."
        rows={3}
        maxLength={500}
        value={gallery.description}
        help="Optional description of the gallery"
      />

      <!-- Image Selection Section -->
      <div class="border-t border-gray-200 pt-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Images</h3>

        <!-- Tabs -->
        <div class="flex gap-4 mb-4 border-b border-gray-200">
          <button
            type="button"
            id="select-tab"
            class="px-4 py-2 border-b-2 border-gray-900 font-medium text-gray-900"
          >
            Select Images
          </button>
          <button
            type="button"
            id="reorder-tab"
            class="px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-900 font-medium"
          >
            Reorder
          </button>
        </div>

        <!-- Select Tab -->
        <div id="select-tab-content" class="space-y-4">
          <ImageSelector selectedImageIds={gallery.images?.map((img: any) => img.id) || []} />
        </div>

        <!-- Reorder Tab -->
        <div id="reorder-tab-content" class="hidden space-y-4">
          <ImageReorderer images={gallery.images || []} />
        </div>
      </div>
    </div>

    <!-- Right Column: Sidebar (1/3 width) -->
    <div class="lg:col-span-1 space-y-6">
      <!-- Publishing Controls -->
      <PublishControls
        status={gallery.status || 'draft'}
        scheduledDate={gallery.scheduledDate}
        createdAt={gallery.createdAt}
        updatedAt={gallery.updatedAt}
      />

      <!-- Hidden Fields -->
      <input type="hidden" name="status" value={gallery.status || 'draft'} />
      <input type="hidden" name="scheduledDate" value={gallery.scheduledDate || ''} />

      <!-- Submit Button -->
      <button
        type="submit"
        id="submit-btn"
        class={`w-full px-6 py-3 rounded-lg text-white font-medium transition-colors ${
          isLoading
            ? 'bg-gray-400 cursor-not-allowed'
            : 'bg-gray-900 hover:bg-gray-800'
        }`}
        disabled={isLoading}
      >
        {isLoading ? 'Creating...' : submitText}
      </button>

      <!-- Auto-save Indicator -->
      <div id="autosave-indicator" class="text-xs text-gray-500 text-center py-2">
        Changes saved automatically
      </div>

      <!-- Gallery Info -->
      {gallery.createdAt && (
        <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600 space-y-1">
          <p>
            <strong>Created:</strong> <time datetime={gallery.createdAt}>{new Date(gallery.createdAt).toLocaleDateString()}</time>
          </p>
          {gallery.updatedAt && gallery.updatedAt !== gallery.createdAt && (
            <p>
              <strong>Updated:</strong> <time datetime={gallery.updatedAt}>{new Date(gallery.updatedAt).toLocaleDateString()}</time>
            </p>
          )}
        </div>
      )}
    </div>
  </div>
</form>

<script type="module" lang="ts">
  import { generateSlug, validateTitle, validateSlug, debounce } from '../utils/forms';
  import { saveDraft, loadDraft, draftExists, clearDraft, setupAutoSave } from '../utils/localStorage';
  import { fetchWithAuth } from '../utils/auth';

  const form = document.getElementById('gallery-form') as HTMLFormElement;
  const titleInput = document.getElementById('title') as HTMLInputElement;
  const slugInput = document.getElementById('slug') as HTMLInputElement;
  const descriptionInput = document.getElementById('description') as HTMLTextAreaElement;
  const regenerateBtn = document.getElementById('regenerate-slug-btn');
  const submitBtn = document.getElementById('submit-btn');
  const alertsContainer = document.getElementById('form-alerts');
  const autosaveIndicator = document.getElementById('autosave-indicator');

  // Tab switching
  const selectTab = document.getElementById('select-tab');
  const reorderTab = document.getElementById('reorder-tab');
  const selectTabContent = document.getElementById('select-tab-content');
  const reorderTabContent = document.getElementById('reorder-tab-content');

  if (selectTab && reorderTab) {
    selectTab.addEventListener('click', () => {
      selectTab.classList.add('border-gray-900', 'text-gray-900');
      selectTab.classList.remove('border-transparent', 'text-gray-600');
      reorderTab.classList.remove('border-gray-900', 'text-gray-900');
      reorderTab.classList.add('border-transparent', 'text-gray-600');

      selectTabContent?.classList.remove('hidden');
      reorderTabContent?.classList.add('hidden');
    });

    reorderTab.addEventListener('click', () => {
      reorderTab.classList.add('border-gray-900', 'text-gray-900');
      reorderTab.classList.remove('border-transparent', 'text-gray-600');
      selectTab.classList.remove('border-gray-900', 'text-gray-900');
      selectTab.classList.add('border-transparent', 'text-gray-600');

      reorderTabContent?.classList.remove('hidden');
      selectTabContent?.classList.add('hidden');
    });
  }

  let isDirty = false;

  const handleBeforeUnload = (e: BeforeUnloadEvent) => {
    if (isDirty) {
      e.preventDefault();
      e.returnValue = '';
    }
  };

  // Check for draft on page load
  const draftKey = `gallery_${form.getAttribute('data-gallery-id') || 'new'}`;
  const draft = loadDraft(draftKey);

  if (draft && draftExists(draftKey)) {
    if (confirm('You have an unsaved draft. Would you like to restore it?')) {
      titleInput.value = draft.data.title || '';
      slugInput.value = draft.data.slug || '';
      descriptionInput.value = draft.data.description || '';
    }
  }

  // Auto-generate slug from title
  const debouncedSlugGenerate = debounce(() => {
    if (!slugInput.hasAttribute('data-manual')) {
      const newSlug = generateSlug(titleInput.value);
      slugInput.value = newSlug;
    }
  }, 300);

  titleInput.addEventListener('input', () => {
    debouncedSlugGenerate();
    isDirty = true;
  });

  // Allow manual slug editing
  slugInput.addEventListener('input', () => {
    slugInput.setAttribute('data-manual', 'true');
  });

  // Regenerate slug button
  if (regenerateBtn) {
    regenerateBtn.addEventListener('click', (e) => {
      e.preventDefault();
      slugInput.removeAttribute('data-manual');
      const newSlug = generateSlug(titleInput.value);
      slugInput.value = newSlug;
    });
  }

  // Track changes
  descriptionInput.addEventListener('input', () => {
    isDirty = true;
  });

  // Setup auto-save
  const getFormData = () => ({
    title: titleInput.value,
    slug: slugInput.value,
    description: descriptionInput.value
  });

  const stopAutoSave = setupAutoSave(draftKey, getFormData, 10000);

  // Handle form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate form
    const titleValidation = validateTitle(titleInput.value, 150);
    const slugValidation = validateSlug(slugInput.value);

    if (!titleValidation.valid || !slugValidation.valid) {
      const errors = [titleValidation, slugValidation]
        .filter(v => !v.valid)
        .map(v => v.error);

      if (alertsContainer) {
        alertsContainer.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
            <p class="font-medium mb-2">Please fix the following errors:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
              ${errors.map(err => `<li>${err}</li>`).join('')}
            </ul>
          </div>
        `;
      }
      return;
    }

    // Clear previous alerts
    if (alertsContainer) {
      alertsContainer.innerHTML = '';
    }

    // Disable submit button
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
    }

    // Get form data
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      // Mock API call - replace with actual API call
      const apiBase = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787/api';
      const galleryId = form.getAttribute('data-gallery-id');
      const endpoint = galleryId ? `${apiBase}/galleries/${galleryId}` : `${apiBase}/galleries`;
      const method = galleryId ? 'PUT' : 'POST';

      const response = await fetchWithAuth(endpoint, {
        method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        throw new Error('Failed to save gallery');
      }

      // Success
      clearDraft(draftKey);
      isDirty = false;
      window.removeEventListener('beforeunload', handleBeforeUnload);
      if (alertsContainer) {
        alertsContainer.innerHTML = `
          <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
            Gallery saved successfully! Redirecting...
          </div>
        `;
      }

      // Redirect after 1 second
      setTimeout(() => {
        window.location.href = '/admin/galleries';
      }, 1000);
    } catch (error) {
      if (alertsContainer) {
        alertsContainer.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
            Error saving gallery: ${error instanceof Error ? error.message : 'Unknown error'}
          </div>
        `;
      }

      // Re-enable submit button
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Try Again';
      }
    }
  });

  // Show unsaved changes warning
  window.addEventListener('beforeunload', handleBeforeUnload);

  // Cleanup auto-save on page unload
  window.addEventListener('unload', () => {
    stopAutoSave();
  });

  // Listen for draft save events
  window.addEventListener('draft-saved', () => {
    if (autosaveIndicator) {
      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      autosaveIndicator.textContent = `Auto-saved at ${time}`;
      autosaveIndicator.classList.remove('text-red-500');
      autosaveIndicator.classList.add('text-green-600');

      setTimeout(() => {
        autosaveIndicator.classList.remove('text-green-600');
        autosaveIndicator.classList.add('text-gray-500');
      }, 3000);
    }
  });
</script>
