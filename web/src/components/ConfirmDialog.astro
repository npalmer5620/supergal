---
export interface Props {
  id: string;
  title: string;
  message: string;
  confirmText?: string;
  cancelText?: string;
  isDangerous?: boolean;
}

const {
  id,
  title,
  message,
  confirmText = 'Confirm',
  cancelText = 'Cancel',
  isDangerous = false
} = Astro.props;

const titleId = `${id}-title`;
const descriptionId = `${id}-description`;
---

<div
  id={id}
  role="dialog"
  aria-modal="true"
  aria-labelledby={titleId}
  aria-describedby={descriptionId}
  class="fixed inset-0 z-50 hidden flex items-center justify-center"
  data-confirm-dialog
>
  <div class="absolute inset-0 bg-black/60" data-dialog-backdrop></div>
  <div class="relative bg-white rounded-lg shadow-lg max-w-sm w-full mx-4 p-6">
    <h2 id={titleId} class="text-xl font-bold text-gray-900 mb-2">
      {title}
    </h2>
    <p id={descriptionId} class="text-gray-600 mb-6">
      {message}
    </p>

    <div class="flex gap-3 justify-end">
      <button
        type="button"
        class="px-4 py-2 rounded-lg border border-gray-200 text-gray-900 hover:bg-gray-50 transition-colors font-medium"
        data-dialog-cancel
      >
        {cancelText}
      </button>
      <button
        type="button"
        class={`px-4 py-2 rounded-lg text-white font-medium transition-colors ${
          isDangerous
            ? 'bg-red-600 hover:bg-red-700'
            : 'bg-gray-900 hover:bg-gray-800'
        }`}
        data-dialog-confirm
      >
        {confirmText}
      </button>
    </div>
  </div>
</div>

<script>
  if (typeof window !== 'undefined') {
    window.showConfirmDialog = function showConfirmDialog(dialogId, onConfirm) {
      const container = document.getElementById(dialogId);
      if (!container) return;

      const confirmBtn = container.querySelector('[data-dialog-confirm]');
      const cancelBtn = container.querySelector('[data-dialog-cancel]');
      const backdrop = container.querySelector('[data-dialog-backdrop]');
      const body = document.body;
      const previouslyFocused = document.activeElement;

      let isClosing = false;

      const cleanup = () => {
        if (isClosing) return;
        isClosing = true;

        container.classList.add('hidden');
        container.removeAttribute('data-open');
        body.classList.remove('overflow-hidden');

        window.removeEventListener('keydown', handleKeydown);
        confirmBtn && confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn && cancelBtn.removeEventListener('click', handleCancel);
        backdrop && backdrop.removeEventListener('click', handleCancel);

        if (previouslyFocused && typeof previouslyFocused.focus === 'function') {
          previouslyFocused.focus();
        }
      };

      const handleCancel = () => {
        cleanup();
      };

      const handleConfirm = async () => {
        try {
          await onConfirm();
        } finally {
          cleanup();
        }
      };

      const handleKeydown = (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          cleanup();
        }
      };

      container.classList.remove('hidden');
      container.setAttribute('data-open', 'true');
      body.classList.add('overflow-hidden');

      window.addEventListener('keydown', handleKeydown);
      confirmBtn && confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn && cancelBtn.addEventListener('click', handleCancel);
      backdrop && backdrop.addEventListener('click', handleCancel);

      requestAnimationFrame(() => {
        if (confirmBtn && typeof confirmBtn.focus === 'function') {
          confirmBtn.focus();
        }
      });
    };
  }
</script>
