---
import { getImages } from '../utils/api';

export interface Props {
  selectedImageIds?: string[];
  onSelect?: string;
}

const { selectedImageIds = [] } = Astro.props;

// Fetch available images
const imagesResult = await getImages(1, 100);
const allImages = imagesResult.success ? imagesResult.data || [] : [];
---

<div class="space-y-4">
  <div class="flex items-center justify-between mb-4">
    <label class="block text-sm font-medium text-gray-700">Select Images</label>
    <button
      type="button"
      id="toggle-grid-btn"
      class="text-xs px-2 py-1 bg-gray-200 text-gray-900 rounded hover:bg-gray-300"
    >
      Toggle View
    </button>
  </div>

  <!-- Search/Filter -->
  <input
    type="text"
    id="image-search"
    placeholder="Search images by title..."
    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent"
  />

  <!-- Images Grid -->
  <div id="images-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
    {allImages.length > 0 ? (
      allImages.map(image => (
        <label
          key={image.id}
          class="relative cursor-pointer group"
          data-image-id={image.id}
          data-image-title={image.title}
        >
          <div class="relative aspect-square bg-gray-200 rounded-lg overflow-hidden">
            <img
              src={image.urls?.thumbnail200 || image.urls?.original}
              alt={image.title}
              class="w-full h-full object-cover group-hover:opacity-75 transition-opacity"
            />
            <div class="absolute inset-0 bg-black opacity-0 group-hover:opacity-30 transition-opacity"></div>
          </div>

          <input
            type="checkbox"
            name="images"
            value={image.id}
            checked={selectedImageIds.includes(image.id)}
            class="absolute top-2 left-2 w-5 h-5 cursor-pointer"
          />

          <div class="absolute inset-0 rounded-lg border-2 border-transparent group-hover:border-gray-900 transition-colors hidden-checkbox-border"></div>

          <p class="text-xs text-gray-600 mt-1 truncate">{image.title || image.filename}</p>
        </label>
      ))
    ) : (
      <div class="col-span-full text-center py-8 text-gray-500">
        <p>No images uploaded yet</p>
        <p class="text-xs">Upload images in the Images section first</p>
      </div>
    )}
  </div>

  <!-- Selected Count -->
  <div class="text-sm text-gray-600">
    <span id="selected-count">0</span> image(s) selected
  </div>

  <!-- Hidden field for form submission -->
  <input type="hidden" id="images-field" name="images" value={selectedImageIds.join(',')} />
</div>

<script lang="ts">
  const checkboxes = document.querySelectorAll('input[name="images"]');
  const imagesField = document.getElementById('images-field') as HTMLInputElement;
  const selectedCountEl = document.getElementById('selected-count');
  const searchInput = document.getElementById('image-search') as HTMLInputElement;
  const toggleGridBtn = document.getElementById('toggle-grid-btn');
  const imagesGrid = document.getElementById('images-grid');

  function updateSelectedImages() {
    const selected = Array.from(checkboxes)
      .filter((cb: any) => cb.checked)
      .map((cb: any) => cb.value);

    imagesField.value = selected.join(',');
    if (selectedCountEl) {
      selectedCountEl.textContent = String(selected.length);
    }

    // Update checkbox borders
    document.querySelectorAll('label[data-image-id]').forEach(label => {
      const checkbox = label.querySelector('input[type="checkbox"]') as HTMLInputElement;
      const border = label.querySelector('.hidden-checkbox-border') as HTMLElement;
      if (checkbox?.checked) {
        border?.classList.add('!border-blue-500');
      } else {
        border?.classList.remove('!border-blue-500');
      }
    });
  }

  // Handle image checkbox changes
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedImages);
  });

  // Search/Filter functionality
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();

      document.querySelectorAll('label[data-image-id]').forEach(label => {
        const title = label.getAttribute('data-image-title')?.toLowerCase() || '';
        const matches = title.includes(searchTerm);
        (label as HTMLElement).style.display = matches ? '' : 'none';
      });
    });
  }

  // Toggle grid view (list vs grid)
  if (toggleGridBtn) {
    let isGrid = true;
    toggleGridBtn.addEventListener('click', () => {
      if (imagesGrid) {
        if (isGrid) {
          imagesGrid.classList.remove('grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');
          imagesGrid.classList.add('grid-cols-1');
          toggleGridBtn.textContent = 'Grid View';
        } else {
          imagesGrid.classList.remove('grid-cols-1');
          imagesGrid.classList.add('grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');
          toggleGridBtn.textContent = 'List View';
        }
        isGrid = !isGrid;
      }
    });
  }

  // Initial update
  updateSelectedImages();

  // Handle checkbox styling for checked state
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      const label = (e.target as HTMLElement).closest('label');
      if (label) {
        if ((e.target as HTMLInputElement).checked) {
          label.classList.add('ring-2', 'ring-blue-500');
        } else {
          label.classList.remove('ring-2', 'ring-blue-500');
        }
      }
    });
  });
</script>
