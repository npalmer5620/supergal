---
import AdminLayout from '../../layouts/AdminLayout.astro';
const apiBase = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787/api';
---

<AdminLayout pageTitle="Manage Images">
  <div class="space-y-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Images</h1>
      <p class="text-gray-600 mt-2">Manage and upload images for your galleries</p>
    </div>

    <!-- Upload Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-bold text-gray-900 mb-4">Upload Image</h2>
      <form id="upload-form" class="space-y-4">
        <div>
          <label for="image" class="block text-sm font-medium text-gray-700 mb-2">
            Select Image
          </label>
          <input
            type="file"
            id="image"
            name="image"
            accept="image/*"
            required
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent"
          />
        </div>

        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
            Image Title
          </label>
          <input
            type="text"
            id="title"
            name="title"
            placeholder="My beautiful photo"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent"
          />
        </div>

        <button
          type="submit"
          class="px-6 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium"
        >
          Upload Image
        </button>
      </form>
    </div>

    <!-- Images List -->
    <div id="images-container" class="space-y-4">
      <!-- Images will be loaded here -->
    </div>
  </div>

  <script is:inline data-api-base={apiBase}>
    ((scriptEl) => {
      if (!(scriptEl instanceof HTMLScriptElement)) return;

      const API_BASE = scriptEl.dataset.apiBase || 'http://localhost:8787/api';
      const form = document.getElementById('upload-form');
      const container = document.getElementById('images-container');
      const API_ORIGIN = (() => {
        try {
          return new URL(API_BASE, window.location.origin).origin;
        } catch {
          return API_BASE.replace(/\/api$/, '');
        }
      })();

      const escapeHtml = (value) =>
        String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      async function fetchJson(url, options = {}) {
        const response = await fetch(url, { credentials: 'include', ...options });
        let payload;
        try {
          payload = await response.clone().json();
        } catch {
          payload = null;
        }

        if (!response.ok) {
          const message =
            payload && (payload.error || payload.message)
              ? payload.error || payload.message
              : `Request failed with status ${response.status}`;
          throw new Error(message);
        }

        return payload;
      }

      function renderMessage(html) {
        if (!container) return;
        container.innerHTML = html;
      }

      function resolveAssetUrl(path) {
        if (!path || typeof path !== 'string') return '';
        if (/^(?:[a-z]+:)?\/\//i.test(path)) {
          return path;
        }
        const base = API_ORIGIN.replace(/\/$/, '');
        const normalizedPath = path.startsWith('/') ? path : `/${path}`;
        return `${base}${normalizedPath}`;
      }

      async function loadImages() {
        if (!container) return;

        renderMessage(`
          <div class="bg-white rounded-lg shadow-md p-12 text-center text-gray-500">
            Loading images...
          </div>
        `);

        try {
          const data = await fetchJson(`${API_BASE}/images?page=1&limit=100`, { method: 'GET' });
          const images = Array.isArray(data) ? data : [];

          if (images.length === 0) {
            renderMessage(`
              <div class="bg-white rounded-lg shadow-md p-12 text-center">
                <p class="text-gray-500">No images uploaded yet.</p>
              </div>
            `);
            return;
          }

          const cards = images
            .map((image) => {
              const thumb = resolveAssetUrl(
                (image && image.urls && (image.urls.thumbnail200 || image.urls.original)) || ''
              );
              const title = escapeHtml(image?.title ?? 'Untitled image');
              const filename = escapeHtml(image?.filename ?? '');
              const id = escapeHtml(image?.id ?? '');

              return `
                <div class="border border-gray-200 rounded-lg overflow-hidden" data-image-card="${id}">
                  <div class="bg-gray-100 h-32 flex items-center justify-center overflow-hidden">
                    ${
                      thumb
                        ? `<img src="${thumb}" alt="${title}" class="w-full h-full object-cover" />`
                        : '<div class="text-gray-400 text-sm">No preview</div>'
                    }
                  </div>
                  <div class="p-3 space-y-2">
                    <p class="font-medium text-gray-900 text-sm">${title}</p>
                    <p class="text-gray-500 text-xs break-all">${filename}</p>
                    <div class="flex gap-2">
                      <button
                        type="button"
                        class="text-xs px-2 py-1 bg-red-100 text-red-900 rounded hover:bg-red-200 transition-colors"
                        data-delete-image="${id}"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              `;
            })
            .join('');

          renderMessage(`
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-6">
                ${cards}
              </div>
            </div>
          `);

          container.querySelectorAll('[data-delete-image]').forEach((button) => {
            button.addEventListener('click', () => {
              const imageId = button.getAttribute('data-delete-image');
              if (!imageId) return;

              const confirmed = window.confirm('Delete this image? This action cannot be undone.');
              if (!confirmed) return;

              fetchJson(`${API_BASE}/images/${encodeURIComponent(imageId)}`, {
                method: 'DELETE'
              })
                .then(() => loadImages())
                .catch((error) => {
                  alert(error instanceof Error ? error.message : 'Failed to delete image.');
                });
            });
          });
        } catch (error) {
          renderMessage(`
            <div class="bg-white rounded-lg shadow-md p-12 text-center text-red-600">
              Failed to load images. ${escapeHtml(error instanceof Error ? error.message : String(error))}
            </div>
          `);
        }
      }

      if (form instanceof HTMLFormElement) {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();

          const fileInput = document.getElementById('image');
          const titleInput = document.getElementById('title');

          if (!(fileInput instanceof HTMLInputElement) || !fileInput.files || fileInput.files.length === 0) {
            alert('Please select an image to upload.');
            return;
          }

          const file = fileInput.files[0];
          const submitButton = form.querySelector('button[type="submit"]');

          if (submitButton instanceof HTMLButtonElement) {
            submitButton.disabled = true;
            submitButton.textContent = 'Uploading...';
          }

          try {
            const formData = new FormData();
            formData.append('image', file);

            if (titleInput instanceof HTMLInputElement && titleInput.value.trim()) {
              formData.append('title', titleInput.value.trim());
            }

            await fetchJson(`${API_BASE}/images`, {
              method: 'POST',
              body: formData
            });

            fileInput.value = '';
            if (titleInput instanceof HTMLInputElement) {
              titleInput.value = '';
            }

            loadImages();
          } catch (error) {
            alert(error instanceof Error ? error.message : 'Failed to upload image.');
          } finally {
            if (submitButton instanceof HTMLButtonElement) {
              submitButton.disabled = false;
              submitButton.textContent = 'Upload Image';
            }
          }
        });
      }

      loadImages();
    })(document.currentScript);
  </script>
</AdminLayout>
