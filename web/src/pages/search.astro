---
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/PostCard.astro';
import GalleryCard from '../components/GalleryCard.astro';
import SearchBar from '../components/SearchBar.astro';
import { search } from '../utils/api';
import { getExcerpt, getReadingTime } from '../utils/markdown';

// Get search query from URL params
const query = Astro.url.searchParams.get('q') || '';
let results: any = { posts: [], galleries: [], images: [] };
let isSearched = false;
let error: string | null = null;

if (query && query.trim().length > 0) {
  isSearched = true;
  const searchResult = await search(query);

  if (searchResult.success && searchResult.data) {
    results = searchResult.data;
  } else {
    error = searchResult.error || 'Search failed. Please try again.';
  }
}

const totalResults = (results.posts?.length || 0) + (results.galleries?.length || 0) + (results.images?.length || 0);
---

<BaseLayout pageTitle="Search" description="Search our blog posts, galleries, and images">
  <!-- Page Header -->
  <section class="bg-gradient-to-br from-gray-50 to-gray-100 py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Search</h1>
      <p class="text-xl text-gray-600 mb-8">Find posts, galleries, and images</p>
      <div class="w-full max-w-md">
        <SearchBar />
      </div>
    </div>
  </section>

  <!-- Results Section -->
  <section class="py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      {!isSearched ? (
        <!-- No Search Yet -->
        <div class="text-center py-12">
          <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <p class="text-gray-500 text-lg mb-2">Enter a search term to get started</p>
          <p class="text-gray-400 text-sm">Search for posts, galleries, or images</p>
        </div>
      ) : error ? (
        <!-- Error State -->
        <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
          <p class="font-medium">Search Error</p>
          <p class="text-sm">{error}</p>
        </div>
      ) : totalResults === 0 ? (
        <!-- No Results -->
        <div class="text-center py-12">
          <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-gray-500 text-lg mb-2">No results found for "{query}"</p>
          <p class="text-gray-400 text-sm">Try different keywords or check the spelling</p>
        </div>
      ) : (
        <!-- Results Found -->
        <div class="space-y-8">
          <!-- Results Summary -->
          <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg">
            <p class="font-medium">
              Found {totalResults} result{totalResults !== 1 ? 's' : ''} for "{query}"
            </p>
          </div>

          <!-- Posts Results -->
          {results.posts && results.posts.length > 0 && (
            <div>
              <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                Posts <span class="text-lg text-gray-500">({results.posts.length})</span>
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                {results.posts.map((post: any) => (
                  <PostCard
                    title={post.title}
                    slug={post.slug}
                    excerpt={post.excerpt || getExcerpt(post.content)}
                    createdAt={post.createdAt}
                    readingTime={getReadingTime(post.content)}
                  />
                ))}
              </div>
            </div>
          )}

          <!-- Galleries Results -->
          {results.galleries && results.galleries.length > 0 && (
            <div>
              <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Galleries <span class="text-lg text-gray-500">({results.galleries.length})</span>
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                {results.galleries.map((gallery: any) => (
                <GalleryCard
                  title={gallery.title}
                  slug={gallery.slug}
                  description={gallery.description}
                  imageCount={gallery.imageCount ?? gallery.images?.length ?? 0}
                  thumbnailUrl={gallery.images?.[0]?.urls?.thumbnail500 || gallery.images?.[0]?.urls?.original}
                />
                ))}
              </div>
            </div>
          )}

          <!-- Images Results -->
          {results.images && results.images.length > 0 && (
            <div>
              <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Images <span class="text-lg text-gray-500">({results.images.length})</span>
              </h2>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {results.images.map((image: any) => (
                  <div class="group relative aspect-square bg-gray-100 rounded-lg overflow-hidden">
                    <img
                      src={image.urls?.thumbnail500 || image.urls?.original}
                      alt={image.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    />
                    <div class="absolute inset-0 bg-black opacity-0 group-hover:opacity-40 transition-opacity duration-300 flex items-end p-3">
                      <div class="text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 w-full">
                        <p class="font-medium text-sm truncate">{image.title}</p>
                        <p class="text-xs text-gray-300 truncate">{image.filename}</p>
                      </div>
                    </div>

                    <a
                      href={image.urls?.original}
                      target="_blank"
                      rel="noreferrer"
                      class="absolute inset-0"
                      title="View full image"
                    />
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  </section>

  <!-- Related Searches Section -->
  {isSearched && totalResults === 0 && (
    <section class="bg-gray-50 py-12">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Suggestions</h2>
        <div class="space-y-4 text-gray-600">
          <p class="text-sm">
            <strong>Tips for better search results:</strong>
          </p>
          <ul class="list-disc list-inside space-y-2 text-sm">
            <li>Try using different keywords</li>
            <li>Check the spelling of your search term</li>
            <li>Use shorter, more specific terms</li>
            <li>Browse our <a href="/blog" class="text-gray-900 hover:underline font-medium">blog</a> or <a href="/galleries" class="text-gray-900 hover:underline font-medium">galleries</a> directly</li>
          </ul>
        </div>
      </div>
    </section>
  )}
</BaseLayout>
