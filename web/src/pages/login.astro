---
import BaseLayout from '../layouts/BaseLayout.astro';
import FormAlert from '../components/FormAlert.astro';
const apiBase = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8787/api';
---

<BaseLayout pageTitle="Admin Login" description="Login to the SuperGal admin panel">
  <div class="min-h-[calc(100vh-160px)] flex items-center justify-center bg-gray-50 py-12 px-4">
    <div class="w-full max-w-md">
      <div class="bg-white rounded-lg shadow-md p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">
          Admin Login
        </h1>
        <p class="text-gray-600 text-center mb-8">
          Sign in to manage your content
        </p>

        <div id="error-alert" class="mb-6"></div>
        <div id="success-alert" class="mb-6"></div>

        <form id="login-form" method="post" class="space-y-4" data-api-base={apiBase}>
          <div>
            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">
              Username
            </label>
            <input
              type="text"
              id="username"
              name="username"
              required
              autocomplete="username"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent"
              placeholder="testadmin"
            />
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent"
              placeholder="••••••••"
            />
          </div>

          <button
            type="submit"
            class="w-full bg-gray-900 text-white py-2 rounded-lg hover:bg-gray-800 transition-colors font-medium"
          >
            Sign In
          </button>
        </form>

        <div class="mt-6 pt-6 border-t border-gray-200">
          <p class="text-sm text-gray-600 text-center">
            First time? You can create an admin account during setup.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    const rawForm = document.getElementById('login-form');
    const API_BASE =
      rawForm instanceof HTMLFormElement && rawForm.dataset.apiBase
        ? rawForm.dataset.apiBase
        : 'http://localhost:8787/api';

    async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE}/auth/session`, {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          window.location.href = '/admin';
        }
      } catch (error) {
        console.error('Auth check failed:', error);
      }
    }

    async function loginRequest(username, password) {
      const response = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        return { success: false, error: error.message || 'Login failed' };
      }

      return { success: true };
    }

    function showMessage(target, markup) {
      if (target) {
        target.innerHTML = markup;
      }
    }

    checkAuth();

    const form = rawForm instanceof HTMLFormElement ? rawForm : null;
    const errorAlert = document.getElementById('error-alert');
    const successAlert = document.getElementById('success-alert');

    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');

        if (!(usernameInput instanceof HTMLInputElement) || !(passwordInput instanceof HTMLInputElement)) {
          return;
        }

        const username = usernameInput.value.trim();
        const password = passwordInput.value;

        if (!username || !password) {
          showMessage(errorAlert, `
            <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
              Please fill in all fields
            </div>
          `);
          return;
        }

        showMessage(errorAlert, '');
        showMessage(successAlert, '');

        try {
          const result = await loginRequest(username, password);

          if (result.success) {
            showMessage(successAlert, `
              <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
                Login successful! Redirecting...
              </div>
            `);

            setTimeout(() => {
              window.location.href = '/admin';
            }, 1000);
          } else {
            showMessage(errorAlert, `
              <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
                ${result.error || 'Login failed. Please try again.'}
              </div>
            `);
          }
        } catch (error) {
          console.error('Login failed:', error);
          showMessage(errorAlert, `
            <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
              An error occurred. Please try again.
            </div>
          `);
        }
      });
    }
  </script>
</BaseLayout>
